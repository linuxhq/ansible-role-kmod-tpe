---
- name: Ensure that the kmod-tpe package is installed
  tags: kmod-tpe
  become: true
  yum:
    enablerepo: elrepo
    name: kmod-tpe
    state: present
  register: kmod_tpe_yum

- name: Attempting to determine if kernel.modules_disabled is enabled
  tags: kmod-tpe
  command: |
    cat /proc/sys/kernel/modules_disabled
  register: kmod_tpe_command
  when: kmod_tpe_yum is success

- name: Attempting to manually load the tpe kernel module
  tags: kmod-tpe
  become: true
  modprobe:
    name: tpe
    state: present
  register: kmod_tpe_modprobe
  when:
    - kmod_tpe_command.stdout != '1'
    - kmod_tpe_yum is success

- name: Applying tpe.conf configuration
  tags: kmod-tpe
  become: true
  template:
    src: tpe.conf.j2
    dest: /etc/sysctl.d/tpe.conf
    owner: root
    group: root
    mode: 0644
  notify: reload sysctl
  when:
    - kmod_tpe_command.stdout != '1'
    - kmod_tpe_modprobe is success
    - kmod_tpe_yum is success
...
